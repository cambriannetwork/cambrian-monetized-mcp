# Cambrian API Monetized MCP Server

A Model Context Protocol (MCP) server that enables monetized access to Cambrian API endpoints through micropayments using the X402 payment protocol.

## Overview

This server allows Claude Desktop (or other MCP clients) to purchase access to Cambrian API endpoints using USDC payments on Base network. Each API call requires a small payment (0.03 USDC) which is automatically processed through the X402 payment facilitator.

## Architecture

### Payment Flow

1. **Client Side (Claude Desktop)**:
   - User requests an API endpoint through MCP tools
   - Client signs a payment transaction using Fluora's payment system
   - Signed transaction is sent to the MCP server

2. **Server Side (This MCP Server)**:
   - Receives the signed transaction
   - Verifies the payment through X402 facilitator
   - If payment succeeds, calls the Cambrian API
   - Returns the API response to the client

3. **Payment Processing**:
   - Uses X402 protocol for trustless payment verification
   - Supports USDC on Base Mainnet and Base Sepolia (testnet)
   - Payments are atomic - API access only granted after payment confirmation

### Key Components

- **MonetizedMCPServer**: Base class from monetizedmcp-sdk that handles MCP protocol
- **PaymentsTools**: SDK component for payment signing and verification
- **X402 Facilitator**: External service that verifies and settles payments
- **Cambrian API**: The actual data API being monetized

## Setup

### Prerequisites

1. Node.js 18+ and npm
2. Cambrian API key (get from Cambrian)
3. USDC wallet with funds on Base network
4. Claude Desktop with Fluora payment configuration

### Installation

```bash
# Clone the repository
git clone https://github.com/cambriannetwork/cambrian-monetized-mcp
cd cambrian-monetized-mcp

# Install dependencies
npm install

# Build the TypeScript code
npm run build
```

### Configuration

1. Create a `.env` file in the project root:

```env
# Cambrian API Configuration
CAMBRIAN_API_KEY=your_cambrian_api_key
CAMBRIAN_API_BASE_URL=https://opabinia.cambrian.org

# Payment Configuration
PAYMENT_RECIPIENT=0x4C3B0B1Cab290300bd5A36AD5f33A607acbD7ac3

# Server Configuration
PORT=3001
```

2. Configure Fluora in Claude Desktop:

Create/update `~/Library/Application Support/Claude/claude_desktop_config.json`:

```json
{
  "fluora": {
    "USDC_BASE_MAINNET": {
      "privateKey": "your_private_key_here"
    },
    "USDC_BASE_SEPOLIA": {
      "privateKey": "your_private_key_here"
    }
  },
  "mcpServers": {
    "cambrian-api": {
      "command": "node",
      "args": ["/path/to/cambrian-monetized-mcp/dist/index.js"],
      "env": {
        "CAMBRIAN_API_KEY": "your_cambrian_api_key"
      }
    }
  }
}
```

### Running the Server

```bash
# Start the server
npm start

# Or for development with auto-reload
npm run dev
```

The server will start on port 3001 (or the port specified in .env).

## Usage

### Available MCP Tools

1. **pricing-listing**: Browse available API endpoints
   - Parameters: `searchQuery` (optional) - filter endpoints by name

2. **payment-method**: Get supported payment methods
   - No parameters required
   - Returns wallet address and supported payment methods

3. **make-purchase**: Purchase access to an API endpoint
   - Parameters:
     - `itemId`: The endpoint ID (e.g., "evmuniv3pool")
     - `paymentMethod`: Payment method (e.g., "USDC_BASE_SEPOLIA")
     - `signedTransaction`: Signed payment from Fluora
     - `params`: API-specific parameters (e.g., chain, pool address)

### Example Usage in Claude Desktop

1. **Find available endpoints**:
   ```
   Use the pricing-listing tool to search for "uniswap"
   ```

2. **Check payment methods**:
   ```
   Use the payment-method tool to see supported payment options
   ```

3. **Make a purchase**:
   ```
   Use the make-purchase tool with:
   - itemId: "evmuniv3pool"
   - paymentMethod: "USDC_BASE_SEPOLIA"
   - signedTransaction: [generated by Fluora]
   - params: {"chain": "8453", "pool": "0x..."}
   ```


## Available Endpoints

The server automatically loads all available endpoints from Cambrian's OpenAPI schema. Common endpoints include:

- **evmuniv3pool**: Get Uniswap V3 pool data
- **evmuniv3pools**: List Uniswap V3 pools for a token
- **evmchains**: List supported EVM chains
- **evmtokens**: Get token information
- **evmaerov2pools**: Get Aerodrome V2 pools

Each endpoint costs 0.03 USDC per call.

## Network Support

### Base Mainnet (Production)
- Chain ID: 8453
- USDC Contract: 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
- Status: Currently experiencing issues (as of writing)

### Base Sepolia (Testnet)
- Chain ID: 84532
- USDC Contract: 0x036CbD53842c5426634e7929541eC2318f3dCF7e
- Status: Fully operational
- Note: Cambrian API returns mock data for testnet

## Technical Details

### Payment Verification

The server uses dynamic resource URLs for payment verification, constructing them from the actual API endpoint being accessed. This ensures each payment is tied to the specific resource being purchased, following production best practices.

### Error Handling

- Invalid endpoint IDs return an error message
- Failed payments return detailed error information
- Cambrian API errors are caught and reported separately from payment errors
- Testnet requests return mock data when Cambrian doesn't support testnet

### Security Considerations

- Private keys should never be committed to version control
- Use environment variables for sensitive configuration
- The server only accepts payments to the configured recipient address
- All payments are verified through the X402 facilitator before granting access

## Troubleshooting

### Common Issues

1. **500 Error on Payment**:
   - Check that the signed transaction hasn't expired
   - Ensure the wallet has sufficient USDC balance
   - Verify the payment recipient address matches

2. **"Invalid endpoint ID"**:
   - Use the pricing-listing tool to find valid endpoint IDs
   - Check that the endpoint ID matches exactly (case-sensitive)

3. **Cambrian API Errors**:
   - Verify your CAMBRIAN_API_KEY is set correctly
   - Check that you're using valid parameters for the endpoint
   - Note that testnet chains will return mock data

### Debug Mode

Set these environment variables for more detailed logging:
```bash
DEBUG=* npm start
```

## Development

### Project Structure

```
cambrian-monetized-mcp/
├── src/
│   └── index.ts          # Main server implementation
├── dist/                 # Compiled JavaScript
├── package.json         # Project dependencies
├── tsconfig.json        # TypeScript configuration
└── .env                 # Environment variables (not in git)
```

### Building

```bash
npm run build
```

### Testing

The server includes automatic payment verification through the MonetizedMCP SDK. All payments are processed through Fluora's integration with Claude Desktop, requiring no manual transaction signing.

## Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

[Add your license here]

## Acknowledgments

- Built with [MonetizedMCP SDK](https://monetizedmcp.org)
- Uses [X402 Protocol](https://x402.org) for payment processing
- Powered by [Cambrian API](https://cambrian.org) for blockchain data